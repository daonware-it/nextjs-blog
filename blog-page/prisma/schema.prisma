generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BlockDraftReport {
  id           Int        @id @default(autoincrement())
  blockDraftId Int
  reason       String
  createdAt    DateTime   @default(now())
  blockDraft   BlockDraft @relation("BlockDraftToReport", fields: [blockDraftId], references: [id])
}

model BlockDraftCommentReport {
  id        Int               @id @default(autoincrement())
  commentId Int
  reason    String
  createdAt DateTime          @default(now())
  comment   BlockDraftComment @relation("BlockDraftCommentToReport", fields: [commentId], references: [id])
}

model BlockDraftLike {
  id           Int        @id @default(autoincrement())
  userId       Int
  blockDraftId Int
  createdAt    DateTime   @default(now())
  ip           String?    @db.VarChar(64)
  blockDraft   BlockDraft @relation("BlockDraftLikes", fields: [blockDraftId], references: [id])
  user         User       @relation("UserBlockDraftLikes", fields: [userId], references: [id])

  @@unique([userId, blockDraftId])
}

model BlockDraftCommentLike {
  id        Int               @id @default(autoincrement())
  userId    Int
  commentId Int
  createdAt DateTime          @default(now())
  ip        String?           @db.VarChar(64)
  comment   BlockDraftComment @relation("BlockDraftCommentLikes", fields: [commentId], references: [id])
  user      User              @relation("UserBlockDraftCommentLikes", fields: [userId], references: [id])

  @@unique([userId, commentId])
}

model BlockDraftComment {
  id                       Int                       @id @default(autoincrement())
  userId                   Int
  blockDraftId             Int
  content                  String
  createdAt                DateTime                  @default(now())
  parentCommentId          Int?
  blockDraft               BlockDraft                @relation("BlockDraftComments", fields: [blockDraftId], references: [id])
  parent                   BlockDraftComment?        @relation("BlockDraftCommentReplies", fields: [parentCommentId], references: [id])
  replies                  BlockDraftComment[]       @relation("BlockDraftCommentReplies")
  user                     User                      @relation("UserBlockDraftComments", fields: [userId], references: [id])
  likes                    BlockDraftCommentLike[]   @relation("BlockDraftCommentLikes")
  blockDraftCommentReports BlockDraftCommentReport[] @relation("BlockDraftCommentToReport")
}

model Newsletter {
  id    Int    @id @default(autoincrement())
  title String
  users User[] @relation("NewsletterToUser")
}

model User {
  id                       Int                     @id @default(autoincrement())
  email                    String                  @unique
  password                 String
  name                     String?
  permissions              String[]                @default([])
  username                 String?                 @unique
  createdAt                DateTime                @default(now())
  lastEmailChange          DateTime?
  lastUsernameChange       DateTime?
  avatarUrl                String?
  updatedAt                DateTime                @default(now()) @updatedAt
  role                     String                  @default("LESER")
  twoFactorEnabled         Boolean                 @default(false)
  twoFactorSecret          String?
  twoFactorRecoveryCodes   String?
  status                   String                  @default("ACTIVE")
  isVerified               Boolean                 @default(false)
  resetPasswordToken       String?
  resetPasswordTokenExpiry DateTime?
  verificationCode         String?
  verificationCodeExpiry   DateTime?
  aiRequests               AiRequest[]
  adminAuditLogs           AuditLog[]              @relation("AdminAuditLogs")
  auditLogs                AuditLog[]              @relation("UserAuditLogs")
  blockDraftsAsCoAuthor    BlockDraft[]            @relation("BlockDraftCoAuthor")
  blockDrafts              BlockDraft[]
  blockDraftComments       BlockDraftComment[]     @relation("UserBlockDraftComments")
  blockDraftCommentLikes   BlockDraftCommentLike[] @relation("UserBlockDraftCommentLikes")
  blockDraftLikes          BlockDraftLike[]        @relation("UserBlockDraftLikes")
  emailHistory             EmailHistory[]
  notifications            Notification[]
  posts                    Post[]
  subscriptions            UserSubscription[]
  usernameHistory          UsernameHistory[]
  newsletters              Newsletter[]            @relation("NewsletterToUser")
  recoveryCodes            RecoveryCode[]
  recoveryCodeAttempts     RecoveryCodeAttempt[]
}

model AiRequest {
  id        Int      @id @default(autoincrement())
  userId    Int
  prompt    String
  result    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model SubscriptionPlan {
  id                    Int                @id @default(autoincrement())
  name                  String             @unique
  price                 Float
  includedRequests      Int
  extraPricePerThousand Float?
  description           String?
  userSubscriptions     UserSubscription[]
}

model UserSubscription {
  id               Int              @id @default(autoincrement())
  userId           Int
  planId           Int
  startedAt        DateTime         @default(now())
  expiresAt        DateTime?
  isActive         Boolean          @default(true)
  includedRequests Int?
  tokensBlocked    Boolean          @default(false)
  plan             SubscriptionPlan @relation(fields: [planId], references: [id])
  user             User             @relation(fields: [userId], references: [id])
}

model UsernameHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  oldUsername String
  newUsername String
  changedAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model EmailHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  oldEmail  String
  newEmail  String
  changedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Post {
  id         Int        @id @default(autoincrement())
  title      String
  content    String
  published  Boolean    @default(false)
  publishAt  DateTime?
  authorId   Int?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  author     User?      @relation(fields: [authorId], references: [id])
  categories Category[] @relation("PostToCategory")
}

model BlockDraft {
  id                Int                 @id @default(autoincrement())
  userId            Int
  blocks            Json
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now()) @updatedAt
  deleteAt          DateTime?
  description       String?
  title             String?
  coAuthorId        Int?
  status            BlockDraftStatus    @default(ENTWURF)
  locked            Boolean             @default(false)
  categoryId        Int?
  category          Category?           @relation(fields: [categoryId], references: [id])
  coAuthor          User?               @relation("BlockDraftCoAuthor", fields: [coAuthorId], references: [id])
  user              User                @relation(fields: [userId], references: [id])
  comments          BlockDraftComment[] @relation("BlockDraftComments")
  likes             BlockDraftLike[]    @relation("BlockDraftLikes")
  blockDraftReports BlockDraftReport[]  @relation("BlockDraftToReport")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  type      String   @default("info")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Category {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  slug        String       @unique
  description String?
  color       String?      @default("#3b82f6")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  parentId    Int?
  blockDrafts BlockDraft[]
  parent      Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]   @relation("CategoryHierarchy")
  posts       Post[]       @relation("PostToCategory")
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    Int
  adminId   Int?
  action    AuditAction
  details   String
  oldValue  String?
  newValue  String?
  createdAt DateTime    @default(now())
  admin     User?       @relation("AdminAuditLogs", fields: [adminId], references: [id])
  user      User        @relation("UserAuditLogs", fields: [userId], references: [id])
}

model EmailTemplate {
  id        Int      @id @default(autoincrement())
  type      String   @unique
  content   String
  updatedAt DateTime @updatedAt
}

model RecoveryCode {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model RecoveryCodeAttempt {
  id          Int      @id @default(autoincrement())
  userId      Int
  attemptedAt DateTime @default(now())
  ip          String?
  user        User     @relation(fields: [userId], references: [id])
}

enum UserStatus {
  ACTIVE
  PENDING
  BANNED
}

enum BlockDraftStatus {
  ENTWURF
  VEROEFFENTLICHT
  GEPLANT
  NICHT_OEFFENTLICH
}

enum Role {
  ADMIN
  BLOGGER
  MODERATOR
  LESER
}

enum AuditAction {
  TOKEN_UPDATE
  TOKEN_BLOCK
  TOKEN_UNBLOCK
  STATUS_CHANGE
  ROLE_CHANGE
  SUBSCRIPTION_CREATE
  SUBSCRIPTION_UPDATE
  SUBSCRIPTION_DELETE
  USER_UPDATE
  USER_CREATE
  USER_DELETE
  POST_CREATE
  POST_UPDATE
  POST_DELETE
  POST_PUBLISH
  BLOCK_DRAFT_CREATE
  BLOCK_DRAFT_UPDATE
  BLOCK_DRAFT_DELETE
  CATEGORY_CREATE
  CATEGORY_UPDATE
  CATEGORY_DELETE
  BLOCK_DRAFT_LOCK
  BLOCK_DRAFT_UNLOCK
}
